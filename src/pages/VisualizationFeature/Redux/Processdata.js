const sampledata =[
  
      {
        "id": 70,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "1",
        "fuel_type_id": "13",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "2",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "3497.6785399999994",
        "co2e_co2_kg": "3497.5685999999996",
        "co2e_ch4_kg": "0.07912",
        "co2e_n2o_kg": "0.03082",
        "usage_required_unit": "8",
        "usage_factor": "13.91",
        "usage_unit_type": "4",
        "usage_in_kwh": "319.93",
        "modified_by": "1",
        "createdAt": "2024-03-08T10:24:09.644Z",
        "updatedAt": "2024-03-08T10:24:09.644Z",
        "site_master": {
          "site": "Site 1"
        },
        "FuelType": {
          "fuel_type": "CNG"
        },
        "use_type_master": {
          "use_type": "Mobile"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 71,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "2",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "2",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-08T12:05:43.466Z",
        "updatedAt": "2024-03-08T12:05:43.466Z",
        "site_master": {
          "site": "Site 2"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Mobile"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 72,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "4",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-08T14:42:56.260Z",
        "updatedAt": "2024-03-08T14:42:56.260Z",
        "site_master": {
          "site": "Site 4"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 73,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-12-22T00:00:00.000Z",
        "quarter": "4",
        "year": "2023",
        "site_id": "3",
        "fuel_type_id": "13",
        "source_type": "renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "3497.6785399999994",
        "co2e_co2_kg": "3497.5685999999996",
        "co2e_ch4_kg": "0.07912",
        "co2e_n2o_kg": "0.03082",
        "usage_required_unit": "8",
        "usage_factor": "13.91",
        "usage_unit_type": "4",
        "usage_in_kwh": "319.93",
        "modified_by": "1",
        "createdAt": "2024-03-08T15:15:04.552Z",
        "updatedAt": "2024-03-08T15:15:04.552Z",
        "site_master": {
          "site": "Site 3"
        },
        "FuelType": {
          "fuel_type": "CNG"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 65,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "2",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-07T09:44:55.974Z",
        "updatedAt": "2024-03-07T09:44:55.974Z",
        "site_master": {
          "site": "Site 2"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 66,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "2",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-07T09:45:15.716Z",
        "updatedAt": "2024-03-07T09:45:15.716Z",
        "site_master": {
          "site": "Site 2"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 67,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "2",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-08T09:45:47.012Z",
        "updatedAt": "2024-03-08T09:45:47.012Z",
        "site_master": {
          "site": "Site 2"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 68,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2016-02-27T00:00:00.000Z",
        "quarter": "4",
        "year": "2016",
        "site_id": "2",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-08T09:46:32.302Z",
        "updatedAt": "2024-03-08T09:46:32.302Z",
        "site_master": {
          "site": "Site 2"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      },
      {
        "id": 69,
        "organization_id": "1",
        "module_id": "1",
        "sub_module_id": "1",
        "bill_date": "2023-06-08T00:00:00.000Z",
        "quarter": "2",
        "year": "2023",
        "site_id": "1",
        "fuel_type_id": "12",
        "source_type": "non-renewable",
        "source": null,
        "use_type_id": "1",
        "consumed_fuel": "0.023",
        "fuel_unit_id": "8",
        "amount_paid": "2332",
        "currency_id": "14",
        "heat_content": "60",
        "carbon_content_value": null,
        "evidence": "https://greenmentor-dev-v1.s3.ap-south-1.amazonaws.com/energy/fuel/1709804690467.zip",
        "status": null,
        "comments": null,
        "calculation_method": "3",
        "input_unit_type": "4",
        "required_unit_type": "4",
        "required_unit": "9",
        "unit_conversion": "1",
        "emission_factor": null,
        "total_co2e_kg": "4180.47195",
        "co2e_co2_kg": "4180.3788",
        "co2e_ch4_kg": "0.05175",
        "co2e_n2o_kg": "0.0414",
        "usage_required_unit": "8",
        "usage_factor": "13.64",
        "usage_unit_type": "4",
        "usage_in_kwh": "313.72",
        "modified_by": "1",
        "createdAt": "2024-03-08T10:14:00.766Z",
        "updatedAt": "2024-03-08T10:14:00.766Z",
        "site_master": {
          "site": "Site 1"
        },
        "FuelType": {
          "fuel_type": "Butane"
        },
        "use_type_master": {
          "use_type": "Staionary"
        },
        "unit_master": {
          "unit": "kilograms"
        },
        "site": null,
        "use_type": null,
        "fuel_type": null
      }
  
]

  const overAllData=[
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Fuel',
      month: 1,
      quarter: 4,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 8519.95,
      total_co2e_kg: 0.6785,
      source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Refrigrent',
      month: 1,
      quarter: 4,
      year: 2023,
      site: 'site-2',
      usage_in_kwh: 519.95,
      total_co2e_kg: 3497.6785,

      source_type:'non-renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 3',
      sub_module: 'Purchased Goods and Services',
      month: 2,
      quarter: 2,
      year: 2023,
      site: 'site-4',
      usage_in_kwh: 519.95,
      total_co2e_kg: 7180.47195,
source_type:'non-renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 3',
      sub_module: 'Purchased Goods',
      month: 2,
      quarter: 2,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 7180.47195,
source_type:'non-renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 2',
      sub_module: 'Electricity',
      month: 3,
      quarter: 3,
      year: 2022,
      site: 'site-3',
      usage_in_kwh: 519.95,
      total_co2e_kg: 4180.47195,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 2',
      sub_module: 'others',
      month: 3,
      quarter: 3,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 4180.47195,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 3',
      sub_module: 'Purchased Goods and Services',
      month: 2,
      quarter: 2,
      year: 2023,
      site: 'site-4',
      usage_in_kwh: 519.95,
      total_co2e_kg: 79180.4,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Fuel',
      month: 1,
      quarter: 4,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 30497.6785,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Fuel',
      month: 1,
      quarter: 4,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 3497.6785,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 2',
      sub_module: 'Electricity',
      month: 3,
      quarter: 3,
      year: 2023,
      site: 'site-3',
      usage_in_kwh: 519.95,
      total_co2e_kg: 4180.47195,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 3',
      sub_module: 'Purchased Goods and Services',
      month: 2,
      quarter: 2,
      year: 2023,
      site: 'site-4',
      usage_in_kwh: 519.95,
      total_co2e_kg: 7180.47195,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Fuel',
      month: 5,
      quarter: 4,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 8497.6785,
source_type:'renewable'
    },
    {
      organization_id: 1,
      module: 'Scope 1',
      sub_module: 'Fuel',
      month: 1,
      quarter: 4,
      year: 2023,
      site: 'site-1',
      usage_in_kwh: 519.95,
      total_co2e_kg: 3497.6785,
source_type:'non-renewable'
    }
  ]
const ElectricityData=[
  {
    "month": 2,
    "quarter": 4,
    "year": 2023,
    "site": "site-1",
    "electricity_source": "Wind",
    "source_type": "renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 2312,
    "total_co2e_kg": 20000
  },
  {
    "month": 2,
    "quarter": 4,
    "year": 2023,
    "site": "site-2",
    "electricity_source": "Wind",
    "source_type": "renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 232,
    "total_co2e_kg": 1750
  },
  {
    "month": 1,
    "quarter": 4,
    "year": 2023,
    "site": "site-3",
    "electricity_source": "Hydro",
    "source_type": "renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 4564,
    "total_co2e_kg": 220
  },
  {
    "month": 7,
    "quarter": 4,
    "year": 2023,
    "site": "site-4",
    "electricity_source": "Solar",
    "source_type": "renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 56567,
    "total_co2e_kg": 9250
  },
  {
    "month": 5,
    "quarter": 4,
    "year": 2023,
    "site": "site-5",
    "electricity_source": "Nuclear",
    "source_type": "renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 908,
    "total_co2e_kg": 440
  },
  {
    "month": 5,
    "quarter": 4,
    "year": 2023,
    "site": "site-6",
    "electricity_source": "Biodiesel",
    "source_type": "renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 786,
    "total_co2e_kg": 180
  },
  {
    "month": 3,
    "quarter": 2,
    "year": 2023,
    "site": "site-7",
    "electricity_source": "Biodiesel",
    "source_type": "renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 676,
    "total_co2e_kg": 59170
  },
  {
    "month": 8,
    "quarter": 4,
    "year": 2023,
    "site": "site-8",
    "electricity_source": "Biomass",
    "source_type": "renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 567,
    "total_co2e_kg": 1160
  },
  {
    "month": 5,
    "quarter": 4,
    "year": 2022,
    "site": "site-9",
    "electricity_source": "Biomass",
    "source_type": "renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 8945,
    "total_co2e_kg": 180
  },
  {
    "month": 6,
    "quarter": 1,
    "year": 2023,
    "site": "site-1",
    "electricity_source": "Coal",
    "source_type": "non-renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 676,
    "total_co2e_kg": 9290
  },
  {
    "month": 7,
    "quarter": 4,
    "year": 2023,
    "site": "site-1",
    "electricity_source": "Coal",
    "source_type": "non-renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 567,
    "total_co2e_kg": 1560
  },
  {
    "month": 7,
    "quarter": 2,
    "year": 2023,
    "site": "site-2",
    "electricity_source": "Gas",
    "source_type": "non-renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 8908,
    "total_co2e_kg": 210
  },
  {
    "month": 8,
    "quarter": 4,
    "year": 2022,
    "site": "site-1",
    "electricity_source": "Gas",
    "source_type": "non-renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 655,
    "total_co2e_kg": 9250
  },
  {
    "month": 9,
    "quarter": 4,
    "year": 2023,
    "site": "site-4",
    "electricity_source": "Diesel",
    "source_type": "non-renewable",
    "transaction_type": "Purchased",
    "usage_in_kwh": 456,
    "total_co2e_kg": 2020
  },
  {
    "month": 9,
    "quarter": 3,
    "year": 2023,
    "site": "site-15",
    "electricity_source": "Diesel",
    "source_type": "non-renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 6767,
    "total_co2e_kg": 180
  },
  {
    "month": 10,
    "quarter": 4,
    "year": 2023,
    "site": "site-6",
    "electricity_source": "Lignite",
    "source_type": "non-renewable",
    "transaction_type": "Captive",
    "usage_in_kwh": 56,
    "total_co2e_kg": 9170
  }]

const calculateRenewableEnergyData = (data, year) => {
  // Filter data for renewable and non-renewable energy
  const filteredDataRenewable = data.filter(entry => entry.year === year && entry.source_type?.toLowerCase() === 'renewable');
  const filteredDataNonRenewable = data.filter(entry => entry.year === year && entry.source_type?.toLowerCase() === 'non-renewable');

  // Calculate total renewable energy for each site
  const totalRenewableEnergyBySite = {};
  filteredDataRenewable.forEach(entry => {
      const { site, usage_in_kwh } = entry;
      totalRenewableEnergyBySite[site] = (totalRenewableEnergyBySite[site] || 0) + parseFloat(usage_in_kwh);
  });

  // Calculate total non-renewable energy for each site
  const totalNonRenewableEnergyBySite = {};
  filteredDataNonRenewable.forEach(entry => {
      const { site, usage_in_kwh } = entry;
      totalNonRenewableEnergyBySite[site] = (totalNonRenewableEnergyBySite[site] || 0) + parseFloat(usage_in_kwh);
  });

  // Calculate total energy for each site
  const totalEnergyBySite = {};
  Object.keys(totalRenewableEnergyBySite).forEach(site => {
      totalEnergyBySite[site] = (totalRenewableEnergyBySite[site] || 0) + (totalNonRenewableEnergyBySite[site] || 0);
  });

  // Calculate renewable energy percentage for each site
  const renewableEnergyPercentageBySite = {};
  Object.keys(totalRenewableEnergyBySite).forEach(site => {
      const totalRenewableEnergy = totalRenewableEnergyBySite[site] || 0;
      const totalEnergy = totalEnergyBySite[site] || 0;
      // Calculate percentage, handle Infinity case
      renewableEnergyPercentageBySite[site] = isFinite(totalRenewableEnergy / totalEnergy) ? ((totalRenewableEnergy / totalEnergy) * 100).toFixed() : 0;
  });

  return renewableEnergyPercentageBySite;
};

const processStackedChartData = (data, year, typebreakdown) => {
  let processedData = {};

  const filteredData = data.filter((entry) => entry.year === year);

  filteredData.forEach((entry) => {
    let { site, total_co2e_kg } = entry;
    total_co2e_kg=Number(total_co2e_kg)
    const breakdown = entry[typebreakdown]||"Total";

    if (!processedData[site]) {
      processedData[site] = {
        site: site,
        breakdown: {},
      };
    }

    if (!processedData[site].breakdown[breakdown]) {
      processedData[site].breakdown[breakdown] = {
        value: 0,
        percentage: 0,
      };
    }

    processedData[site].breakdown[breakdown].value += total_co2e_kg;
  });


  Object.values(processedData).forEach((entry) => {
    let total = 0;


    Object.values(entry.breakdown).forEach((breakdown) => {
      total += breakdown.value;
    });

   
    Object.keys(entry.breakdown).forEach((breakdown) => {
      const breakdownValue = entry.breakdown[breakdown].value;
      entry.breakdown[breakdown].percentage = total !== 0 ? (breakdownValue / total) * 100 : 0;
    });
  });
  return processedData;
};
export const generateSeriesDataForStackedChart = (processedData,renewableEnergyData) => {
console.log(renewableEnergyData)
  const xAxisData = Object.keys(processedData);
  const legends = new Set();
  Object.values(processedData).forEach((entry) => {
    Object.keys(entry?.breakdown).forEach((breakdown) => {
      legends.add(breakdown);
    });
  });

  const series = [...legends].map((legend) => ({
    name: legend,
    type: "bar",
    stack: "total",
    label: {
      show: true,
      formatter: (params) => {
        const site = params.name;
        const entry = processedData[site]?.breakdown[params.seriesName];
        const percentage = entry?.percentage;
        if (percentage !== undefined && !isNaN(percentage) && percentage !== 0) {
          return `${percentage.toFixed()}%`;
        } else {
          return '';
        }
      } 
    },
    data: xAxisData.map(
      (site) => processedData[site]?.breakdown[legend]?.value || 0
    ),
  }));
  series.push({
    name: 'Renewable Energy Usage',
    type: 'line',
    label:{show:true,formatter:`{c}%`},

    data: xAxisData.map((site) => renewableEnergyData[site] || 0),
  });

  // console.log(series)
  return {series,legends};
};
export const formatText = (text) => {
  
  const words = text.split('_');


  const capitalizedWords = words.map(word => word.charAt(0).toUpperCase() + word.slice(1));

  
  const formattedText = capitalizedWords.join(' ');

  return formattedText;
};

  
  // current year and last year total emission
function currentYearLastYearEmissionDetail(data,currentYear=2023){
 
  const currentYearData = data?.filter(entry => entry.year === currentYear);
  const previousYearData = data?.filter(entry => entry.year === currentYear - 1);
  const totalEmissionsCurrentYear = currentYearData.reduce((total, entry) => total + Number(entry.total_co2e_kg), 0);
  const totalEmissionsPreviousYear = previousYearData.reduce((total, entry) => total + Number(entry.total_co2e_kg), 0);
 
  const percentageChange = ((totalEmissionsCurrentYear - totalEmissionsPreviousYear) / totalEmissionsPreviousYear) * 100;

  const roundedPercentageChange = Math.floor(percentageChange)
 
  return {currentYear:Math.floor(totalEmissionsCurrentYear),previousYear:Math.floor(totalEmissionsPreviousYear), percentageChange:roundedPercentageChange};
}
function calculateEnergyUsageChange(data, currentYear = 2023) {
    const currentYearData = data?.filter(entry => entry.year === currentYear);
    const previousYearData = data?.filter(entry => entry.year === currentYear - 1);

    const totalEnergyUsageCurrentYear = currentYearData.reduce((total, entry) => total + entry.usage_in_kwh, 0);
    const totalEnergyUsagePreviousYear = previousYearData.reduce((total, entry) => total + entry.usage_in_kwh, 0);

    let percentageChange;
    if (totalEnergyUsagePreviousYear !== 0) {
        percentageChange = ((totalEnergyUsageCurrentYear - totalEnergyUsagePreviousYear) / totalEnergyUsagePreviousYear) * 100;
    } else {
        percentageChange = totalEnergyUsageCurrentYear !== 0 ? 100 : 0; // If both years are zero, set percentageChange to 0
    }

    return {
        currentYear: Math.floor(totalEnergyUsageCurrentYear),
        previousYear: Math.floor(totalEnergyUsagePreviousYear),
        percentageChange: Math.floor(percentageChange)
    };
}

// Calculate percentage of renewable energy usage for the current year and the previous year
function calculateRenewableEnergyUsageChange(data,currentYear) {
  

  
  const currentYearData = data?.filter(entry => entry.year===currentYear);
  const previousYearData = data?.filter(entry => entry.year===currentYear - 1);

  const totalUsageCurrentYear = currentYearData.reduce((total, entry) => total + entry.usage_in_kwh, 0);
  const totalUsagePreviousYear = previousYearData.reduce((total, entry) => total + entry.usage_in_kwh, 0);

  const renewableUsageCurrentYear = currentYearData.reduce((total, entry) => {
      if (entry.source_type?.toLowerCase() === 'renewable') {
       
          return total + entry.usage_in_kwh;
      }
      return total;
  }, 0);

  const renewableUsagePreviousYear = previousYearData.reduce((total, entry) => {
      if (entry.source_type?.toLowerCase() === 'renewable') {

          return total + entry.usage_in_kwh;
      }
      return total;
  }, 0);
  const percentageRenewableCurrentYear = (renewableUsageCurrentYear / totalUsageCurrentYear)*100||0;
  const percentageRenewablePreviousYear = (renewableUsagePreviousYear / totalUsagePreviousYear) * 100||0;
  
  
 
  const percentageChange = ((percentageRenewableCurrentYear - percentageRenewablePreviousYear) / percentageRenewablePreviousYear) * 100||0;



  return {
      currentYearPercentage: Math.floor(percentageRenewableCurrentYear),
      previousYearPercentage: Math.floor(percentageRenewablePreviousYear),
      percentageChange: Math.floor(percentageChange)
  };
}



function getMonthName(monthNumber) {
  const date = new Date();
  date.setMonth(monthNumber - 1);

  return date.toLocaleString('en-US', {
    month: 'short',
  });
}
function processData(Inputdata, timeInterval, breakpoint, year) {
  let data;

  if (year) {
      data = Inputdata.filter((entry) => entry.year === year);
      data.sort((a, b) => a.quarter - b.quarter);
  } else {
      function sortByYearAndQuarter(a, b) {
          if (a.year !== b.year) {
              return a.year - b.year;
          } else {
              return a.quarter - b.quarter;
          }
      }

      Inputdata.sort(sortByYearAndQuarter);
      data = Inputdata;
      data.sort((a, b) => a.month - b.month);
  }

  let processedData = {};

  data.forEach((entry) => {
      let { year, quarter, total_co2e_kg, month } = entry;
      total_co2e_kg = Number(total_co2e_kg);

      let filter = entry[breakpoint] || "Total";

      switch (timeInterval) {
          case "Year":
              if (!processedData[year]) {
                  processedData[year] = {};
              }
              if (!processedData[year][filter]) {
                  processedData[year][filter] = {
                      emissionFactors: [],
                      usage_in_kwh_data: 0,
                      totalEmissionFactor: "",
                      totalEmission: 0,
                  };
              }
              processedData[year][filter].emissionFactors.push(total_co2e_kg);
              processedData[year][filter].usage_in_kwh_data += Number(entry["usage_in_kwh"]);
              processedData[year][filter].totalEmission += total_co2e_kg;
              break;

          case "Quarter":
              const quarterKey = `${year}-Q${quarter}`;
              if (!processedData[quarterKey]) {
                  processedData[quarterKey] = {};
              }
              if (!processedData[quarterKey][filter]) {
                  processedData[quarterKey][filter] = {
                      emissionFactors: [],
                      totalEmissionFactor: "",
                      usage_in_kwh_data: 0,
                      totalEmission: 0,
                  };
              }
              processedData[quarterKey][filter].emissionFactors.push(total_co2e_kg);
              processedData[quarterKey][filter].usage_in_kwh_data += Number(entry["usage_in_kwh"]);
              processedData[quarterKey][filter].totalEmission += total_co2e_kg;
              break;

          case "Month":
              const monthKey = `${year}-${getMonthName(month)}`;
              if (!processedData[monthKey]) {
                  processedData[monthKey] = {};
              }
              if (!processedData[monthKey][filter]) {
                  processedData[monthKey][filter] = {
                      emissionFactors: [],
                      totalEmissionFactor: "",
                      usage_in_kwh_data: 0,
                      totalEmission: 0,
                  };
              }
              processedData[monthKey][filter].emissionFactors.push(total_co2e_kg);
              processedData[monthKey][filter].usage_in_kwh_data += Number(entry["usage_in_kwh"]);
              processedData[monthKey][filter].totalEmission += total_co2e_kg;
              break;

          default:
              break;
      }
  });

  for (const timeKey in processedData) {
      for (const Key in processedData[timeKey]) {
          const factors = processedData[timeKey][Key].emissionFactors;
          let sum = factors.reduce((acc, curr) => acc + curr, 0);

          processedData[timeKey][Key].totalEmissionFactor = sum.toFixed();
      }
  }

  return processedData;
}
function processDataForSourceType(Inputdata, timeInterval,breakpoint,year) {
  let data;
  
 if(year){
   data = Inputdata.filter((entry) => entry.year === year);
   data.sort((a,b)=>a.quarter - b.quarter);
 }else{
  function sortByYearAndQuarter(a, b) {
    if (a.year !== b.year) {
      return a.year - b.year;
    } else {
      return a.quarter - b.quarter; 
    }
  }
  
  
  Inputdata.sort(sortByYearAndQuarter);
  data=Inputdata
  data.sort((a, b) => a.month - b.month);
 }

 let processedData = {};

 data.forEach((entry) => {
   const { year, quarter,month} = entry;
 let filter=entry[breakpoint]||"total"
   switch (timeInterval) {
     case "Year":
       if (!processedData[year]) {
         processedData[year] = {};
       }
       if (!processedData[year][filter]) {
         processedData[year][filter] = {
          
           usage_in_kwh_data:0,
         
         };
       }
    
       processedData[year][filter].usage_in_kwh_data+=Number(entry["usage_in_kwh"]);

      
       break;

     case "Quarter":
       const quarterKey = `${year}-Q${quarter}`;
       if (!processedData[quarterKey]) {
         processedData[quarterKey] = {};
       }
       if (!processedData[quarterKey][filter]) {
         processedData[quarterKey][filter] = {
          
           usage_in_kwh_data:0,
          
         };
       }
     case "Month":
       const monthKey = `${year}-${getMonthName(month)}`;
       if (!processedData[monthKey]) {
         processedData[monthKey] = {};
       }
       if (!processedData[monthKey][filter]) {
         processedData[monthKey][filter] = {
          
           usage_in_kwh_data:0,
          
         };
       }
     
      
       processedData[monthKey][filter].usage_in_kwh_data+=entry["usage_in_kwh"];
       
       break;

     default:
       break;
   }
 });





 return processedData;
}

function processDataToLablesAndDataSets(data) {

    let series = [];
    let legends = [];
    let xAxisLabels = Object.keys(data);


    for (const timeKey in data) {
      for (const key in data[timeKey]) {
      
     
            if (!legends.includes(key)) {
                legends.push(key);
            }
        }
    }
 
    for (const legend of legends) {
        let seriesData = [];
        let usage_in_kwh_data=[]

        for (const timeKey of xAxisLabels) {
            if (data[timeKey][legend]) {
                seriesData.push(data[timeKey][legend].totalEmission);
                usage_in_kwh_data.push(data[timeKey][legend]?.usage_in_kwh_data);
            } else {
                seriesData.push(0); // Placeholder for missing data
            }
        }

        series.push({
          usage_in_kwh_data,
            name: legend,
            type: 'bar',
            stack: 'total',
            barWidth: '20%',
            label: {
              show: false,
              
          },
            
            data: seriesData
        });
    }
// console.log(series,xAxisLabels);
    return { xAxisLabels, series };
}
function processSourceTypeDataToLablesAndDataSets(data) {

    let series = [];
    let legends = [];
    let xAxisLabels = Object.keys(data);


    for (const timeKey in data) {
        for (const key in data[timeKey]) {
     
            if (!legends.includes(key)) {
                legends.push(key);
            }
        }
    }
 
    for (const legend of legends) {
        let seriesData = [];
        let usage_in_kwh_data=[]

        for (const timeKey of xAxisLabels) {
            if (data[timeKey][legend]) {
                seriesData.push(data[timeKey][legend]?.usage_in_kwh_data);
                usage_in_kwh_data.push(data[timeKey][legend]?.usage_in_kwh_data);
            } else {
                seriesData.push(0); // Placeholder for missing data
            }
        }

        series.push({
          usage_in_kwh_data,
            name: legend,
            type: 'bar',
            stack: 'total',
            barWidth: '20%',
            label: {
              show: false
            },
            
            data: seriesData
        });
    }

    return { xAxisLabels, series };
}


const generatePieChartOptions = (text,filteredData, breaktype,currentFinancialYear) => {
  const {series}=breaktype!=="source_type"?processDataToLablesAndDataSets(
    processData(filteredData, 'Year', breaktype,currentFinancialYear)
    ):processSourceTypeDataToLablesAndDataSets( processData(filteredData, 'Year', breaktype,currentFinancialYear))

  const pieChartData =
  series &&
  series.map((dataItem) => ({
    
    value: dataItem?.data?.reduce((acc, curr) => acc + Number(curr), 0).toFixed(),
    name: dataItem.name,
  }));
  return {
    title: {
      text,
      left: "center",
    },
    tooltip: {
      trigger: "item",
      formatter: (params) => {
        const entry = series.find((item) => params.name === item.name);
        let tooltipText = '';
        switch (breaktype) {
          case "fuel_type":
            tooltipText += `${params.name}<br/>Emissions: ${parseFloat(params.value).toFixed()} Co2e <br/>Energy Usage: ${parseFloat(entry?.usage_in_kwh_data).toFixed()} kwh<br/>Emission Intensity: ${parseFloat((params.value) / entry?.usage_in_kwh_data).toFixed(4)}`;
            break;
          case "source_type":
            tooltipText += `${params.name}<br/>Energy Usage: ${parseFloat(entry?.usage_in_kwh_data).toFixed()} kwh`;
            break;
          default:
            tooltipText += `${params.name}<br/>Emissions: ${parseFloat(params.value).toFixed()}<br/>Energy Usage: ${parseFloat(entry?.usage_in_kwh_data).toFixed(0)} kwh `
            break;
        }
        return tooltipText
      },
    },
    legend: {
      bottom: "5%",
      top: "bottom",
    },
    series: [
      {
        type: "pie",
        radius: ["40%", "70%"],
        avoidLabelOverlap: false,
        label: {
          position: "inside",
          show: true,
          fontSize: 10,
          fontWeight: "bold",
          formatter: (params) => {
            return `${params?.percent?.toFixed()}%`;
          },
        },
        labelLine: {
          show: true,
        },
        data: pieChartData,
      },
    ],
  };
};
const generateChartOption = (titleText, legendData, xAxisLabels, series) => {
  return {
    title: {
      text: titleText,
      left: 'center',
    },
    toolbox: {
      show: true,
      orient: 'vertical',
      left: 'right',
      top: 'center',
      feature: {
        mark: { show: true },
        dataView: { show: true, readOnly: true },
        magicType: { show: true, type: ['line', 'bar'] },
        restore: { show: true },
        saveAsImage: { show: true },
      },
    },
    resposive: false,
    tooltip: {
      trigger: 'item',
      formatter: (params) => {
        return `${params.seriesName} <br/> ${params.value.toFixed()} Co2e`;
      },
    },
    legend: {
      selectedMode: !legendData,
      top: 'bottom',
    },
    labelLine: {
      show: true,
    },
    grid: {
      left: 100,
      right: 100,
      top: 50,
      bottom: 50,
      containLabel: false,
    },
    yAxis: {
      type: 'value',
      axisLabel: {
        formatter: '{value} CO2e',
      },
    },
    xAxis: {
      type: 'category',
      data: xAxisLabels,
    },
    series: series,
  };
};

const generateStackedChartOptions = (
  chartData,
  currentFinancialYear,
  typeBreakdown,
  legends,
  xAxisData,
  series
) => {
  const currentYearChartData = chartData.filter(item => item.year === currentFinancialYear);
 
  if (!currentYearChartData || !currentYearChartData.length) {
    console.warn("No data available for the current financial year.");
    return {};
  }

  // Calculate renewable energy percentage by site
  const renewableEnergyPercentageBySite = calculateRenewableEnergyData(currentYearChartData, currentFinancialYear);
  const yAxis = [
    {
      type: "value",
      axisLabel: {
        formatter: "{value} CO2e",
      },
    },
    {
      type: "value",
      max: 100, 
      axisLabel: {
        formatter: "{value}%",
      },
      splitLine: {
        show: false,
      },
    },
  ];

  return {
    title: { text: "Sitewise Emissions", left: "center" },
    tooltip: {
      trigger: "item",
      formatter: function (params) {
        let tooltipContent = "";

        if (params.seriesType === 'bar') {
          tooltipContent += `${params.seriesName}<br/>Emission: ${params.value.toFixed()} Co2e<br/>`;

          if (params.seriesName !== "Renewable Energy Usage") {
            const entry = currentYearChartData?.filter(item => item[typeBreakdown] === params.seriesName);
            if (entry && entry.length > 0) {
              let totalUses = entry.reduce((acc, curr) => acc + Number(curr["usage_in_kwh"]), 0);
              let totalEmission = entry.reduce((acc, curr) => acc + Number(curr["total_co2e_kg"]), 0);
              tooltipContent += `Energy Usage: ${totalUses.toFixed()} kWh<br/>`;
              tooltipContent += `Emission Intensity: ${(totalEmission / totalUses).toFixed(2)}<br/>`;
            } else {
              console.warn(`No data found for ${params.seriesName}.`);
            }
          }
        } else if (params.seriesType === 'line' && params.seriesName === 'Renewable Energy Usage') {
          const renewableEntries = currentYearChartData.filter(item => item.site === params.name&&item.source_type?.toLowerCase() ==='renewable');
          const sumCurrentYearEnergyUses = renewableEntries.reduce((sum, entry) => {
            if (entry.year === currentFinancialYear) {
              sum += parseFloat(entry.usage_in_kwh);
            }
            return sum;
          }, 0);
          tooltipContent += `${params.name} <br/>Renewable Energy Usage: ${sumCurrentYearEnergyUses.toFixed()}kWh<br/>`;
        }

        // // Include renewable energy percentage in the tooltip for bar series
        // if (params.seriesType === 'bar' && renewableEnergyPercentageBySite[params.name] !== undefined) {
        //   tooltipContent += `Renewable Energy Percentage: ${renewableEnergyPercentageBySite[params.name].toFixed(2)}%<br/>`;
        // }

        return tooltipContent;
      }
    },
    legend: {
      data: [...legends, 'Renewable Energy Usage'], // Include legend for line series
      top: "bottom",
    },
    xAxis: {
      type: "category",
      data: xAxisData,
    },
    yAxis: yAxis,
    series: series.map((s, index) => {
      if (s.type === 'line') {
        return {
          ...s,
          yAxisIndex: 1, // Assigning to the secondary y-axis
          name: 'Renewable Energy Usage', // Assign a name for the legend

        };
      }
      return s;
    }),
  };
};

const generateOptionforSunburst = (InputData, currentFinancialYear) => {
  const data = InputData.filter(item => item.year === currentFinancialYear);   /// currentFinancialYear filter 
  if (!Array.isArray(data) || data.length === 0) {
    console.error("Invalid or empty data provided");
    return {}; // Return empty option object if data is invalid or empty
  }

  // Calculate total CO2 emissions for each module and overall
  const moduleTotals = {};
  let totalEmissions = 0;
  data.forEach((entry) => {
    const moduleName = entry.module;
    const subModuleName = entry.sub_module;
    const emissions = entry.total_co2e_kg;

    // Calculate total emissions
    totalEmissions += emissions;

    // Calculate emissions for each module and sub-module
    if (!moduleTotals[moduleName]) {
      moduleTotals[moduleName] = { total: 0, subModules: {} };
    }
    moduleTotals[moduleName].total += emissions;

    if (!moduleTotals[moduleName].subModules[subModuleName]) {
      moduleTotals[moduleName].subModules[subModuleName] = 0;
    }
    moduleTotals[moduleName].subModules[subModuleName] += emissions;
  });

  // Transform data for sunburst chart
  const transformDataForSunburst = (data) => {
    const formattedData = [];
    for (const moduleName in moduleTotals) {
      const moduleTotal = moduleTotals[moduleName].total;
      const modulePercentage = (moduleTotal / totalEmissions) * 100;
      const moduleData = {
        name: `${moduleName} (${modulePercentage.toFixed()}%)`,
        value: moduleTotal,
        children: [],
      };
      for (const subModuleName in moduleTotals[moduleName].subModules) {
        const subModuleEmissions = moduleTotals[moduleName].subModules[subModuleName];
        const percentage = (subModuleEmissions / moduleTotal) * 100;
        moduleData.children.push({
          name: `${subModuleName} (${percentage.toFixed()}%)`,
          value: subModuleEmissions,
        });
      }
      formattedData.push(moduleData);
    }
    return formattedData;
  };

  // Generate option for the sunburst chart
  const option = {
    tooltip: {},
    // visualMap: {
      // type: 'piecewise',
      // min: 0,
      // max: 50000,
      // inRange: {
      //   color: ['#2F93C8', '#AEC48F', '#FFDB5C', '#F98862']
      // }
    // },
    title: {
      text: "Scope wise emission split",
      left: "center",
    },
    series: {
      type: "sunburst",
      data: transformDataForSunburst(data),
      radius: [80, "90%"],
      label: {
        show: true,
        formatter: (params) => {
          return `${params.name}`;
        },
        rotate: "radial",
        // fontSize: 10, 
        fontWeight:600,
      },
      itemStyle: {
        borderRadius: 5,
        borderWidth: 2,
      },
    },
  };

  return option;
};








export {processData,processDataForSourceType,generateStackedChartOptions,processDataToLablesAndDataSets,currentYearLastYearEmissionDetail,calculateRenewableEnergyUsageChange,calculateEnergyUsageChange,processSourceTypeDataToLablesAndDataSets,sampledata,processStackedChartData,generatePieChartOptions,generateChartOption,calculateRenewableEnergyData,overAllData,ElectricityData,generateOptionforSunburst}
